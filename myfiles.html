<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>My Files</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
        padding: 20px;
        background: #f5f7fa;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .actions {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .btn {
        padding: 10px 20px;
        background: #4a90e2;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }
    .btn:hover {
        background: #357ae8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(53, 122, 232, 0.3);
    }
    .btn-delete {
        background: #e74c3c;
    }
    .btn-delete:hover {
        background: #c0392b;
    }
    .btn-download {
        background: #2ecc71;
    }
    .btn-download:hover {
        background: #27ae60;
    }
    .btn-share {
        background: #9b59b6;
    }
    .btn-share:hover {
        background: #8e44ad;
    }
    .files-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .files-table th {
        background: #f8fafc;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
    }
    .files-table td {
        padding: 15px;
        border-bottom: 1px solid #e2e8f0;
    }
    .files-table tr:hover {
        background: #f8fafc;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }
    .empty-state i {
        font-size: 48px;
        color: #cbd5e1;
        margin-bottom: 20px;
    }
    .loading {
        text-align: center;
        padding: 40px;
        color: #64748b;
    }
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4a90e2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Modal styles for share link */
    .share-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .share-modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .share-link-box {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        word-break: break-all;
        font-family: monospace;
        border: 2px solid #e2e8f0;
    }
    .share-modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-folder"></i> My Files</h1>
      <div class="actions">
        <a href="/upload" class="btn">
          <i class="fas fa-plus"></i> Upload New
        </a>
        <a href="/" class="btn" style="background: #64748b;">
          <i class="fas fa-home"></i> Home
        </a>
        <button onclick="refreshFiles()" class="btn" style="background: #8b5cf6;">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading your files...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <i class="fas fa-inbox"></i>
      <h3>No files uploaded yet</h3>
      <p>Upload your first file to get started</p>
      <a href="/upload" class="btn" style="margin-top: 20px;">
        <i class="fas fa-cloud-upload-alt"></i> Upload File
      </a>
    </div>

    <!-- Files Table -->
    <div id="filesTable" style="display: none;">
      <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
        <strong>Total Files:</strong> <span id="fileCount">0</span>
      </div>
      <table class="files-table">
        <thead>
          <tr>
            <th>Filename</th>
            <th>Size</th>
            <th>Privacy</th>
            <th>Uploaded</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="filesList"></tbody>
      </table>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" style="display: none; padding: 20px; background: #fee2e2; color: #991b1b; border-radius: 8px; margin: 20px 0;">
      <i class="fas fa-exclamation-triangle"></i> <span id="errorText"></span>
    </div>
  </div>

  <script>
    const API_URL = "http://127.0.0.1:5000";

    // Get token from localStorage
    function getToken() {
        return localStorage.getItem("token");
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Show error message
    function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        const errorText = document.getElementById("errorText");
        errorText.textContent = message;
        errorDiv.style.display = "block";

        setTimeout(() => {
            errorDiv.style.display = "none";
        }, 5000);
    }

    // Load user's files
    async function loadFiles() {
        const token = getToken();

        if (!token) {
            showError("Please login to view your files");
            setTimeout(() => window.location.href = "/login", 2000);
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/my-files`, {
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            const files = await response.json();

            if (response.ok) {
                displayFiles(files);
            } else {
                showError(files.error || "Failed to load files");
            }
        } catch (error) {
            console.error("Error loading files:", error);
            showError("Network error. Please try again.");
        }
    }

    // Display files in table
    function displayFiles(files) {
        const loadingState = document.getElementById("loadingState");
        const emptyState = document.getElementById("emptyState");
        const filesTable = document.getElementById("filesTable");
        const filesList = document.getElementById("filesList");

        loadingState.style.display = "none";

        if (!files || files.length === 0) {
            emptyState.style.display = "block";
            filesTable.style.display = "none";
            return;
        }

        emptyState.style.display = "none";
        filesTable.style.display = "block";

        // Update file count
        document.getElementById("fileCount").textContent = files.length;

        // Clear existing rows
        filesList.innerHTML = "";

        // Add each file as a row
        files.forEach(file => {
            const ext = file.filename.split('.').pop().toLowerCase();
            const icon = ext === 'pdf' ? 'fas fa-file-pdf text-red-500' :
                        ext === 'mp4' ? 'fas fa-file-video text-purple-500' :
                        'fas fa-file text-gray-500';

            const privacyBadge = file.privacy === 'public' ?
                '<span style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Public</span>' :
                '<span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Private</span>';

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <i class="${icon}" style="margin-right: 10px;"></i>
                    ${file.filename}
                </td>
                <td>${formatFileSize(file.size || 0)}</td>
                <td>${privacyBadge}</td>
                <td>${formatDate(file.uploaded_at)}</td>
                <td>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="downloadFile('${file._id}')" class="btn-download btn" style="padding: 6px 12px; font-size: 14px;">
                            <i class="fas fa-download"></i> Download
                        </button>
                        ${file.privacy === 'private' ? `
                        <button onclick="generateShareLink('${file._id}', '${file.filename}')" class="btn-share btn" style="padding: 6px 12px; font-size: 14px;">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                        ` : ''}
                        <button onclick="deleteFile('${file._id}', '${file.filename}')" class="btn-delete btn" style="padding: 6px 12px; font-size: 14px;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            `;
            filesList.appendChild(row);
        });
    }

    // Download file
    async function downloadFile(fileId) {
        window.open(`${API_URL}/api/files/${fileId}/download`, '_blank');
    }

    // Generate share link for private file
    async function generateShareLink(fileId, filename) {
        const token = getToken();
        if (!token) {
            showError("Please login to generate share links");
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/files/${fileId}/share`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (response.ok) {
                showShareModal(result.share_url, filename);
            } else {
                alert(result.error || "Failed to generate share link");
            }
        } catch (error) {
            console.error("Error generating share link:", error);
            alert("Network error. Please try again.");
        }
    }

    // Show share modal with link
    function showShareModal(shareUrl, filename) {
        const modal = document.createElement("div");
        modal.className = "share-modal";
        modal.innerHTML = `
            <div class="share-modal-content">
                <h2><i class="fas fa-link"></i> Shareable Link</h2>
                <p>Share this link with others to allow them to download <strong>"${filename}"</strong>:</p>
                <div class="share-link-box">${shareUrl}</div>
                <p style="color: #666; font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Anyone with this link can download the file (no login required)
                </p>
                <div class="share-modal-actions">
                    <button onclick="copyToClipboard('${shareUrl}')" class="btn" style="background: #4a90e2;">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                    <button onclick="closeModal(this)" class="btn" style="background: #64748b;">
                        Close
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    }

    // Close modal
    function closeModal(modalElement) {
        const modal = modalElement.closest ? modalElement.closest('.share-modal') : modalElement;
        if (modal) {
            document.body.removeChild(modal);
        }
    }

    // Copy text to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Share link copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Share link copied to clipboard!');
        });
    }

    // Delete file
    async function deleteFile(fileId, filename) {
        if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
            return;
        }

        const token = getToken();
        if (!token) {
            showError("Please login to delete files");
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/files/${fileId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message || "File deleted successfully");
                loadFiles(); // Reload the file list
            } else {
                alert(result.error || "Failed to delete file");
            }
        } catch (error) {
            console.error("Error deleting file:", error);
            alert("Network error. Please try again.");
        }
    }

    // Refresh files
    function refreshFiles() {
        document.getElementById("loadingState").style.display = "block";
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("filesTable").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";

        loadFiles();
    }

    // Check login status and load files on page load
    document.addEventListener('DOMContentLoaded', () => {
        const token = getToken();
        if (!token) {
            showError("Please login to view your files");
            setTimeout(() => window.location.href = "/login", 2000);
            return;
        }

        loadFiles();
    });
  </script>
</body>
</html>
