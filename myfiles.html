<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>My Files</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .container{max-width:900px;margin:20px auto;padding:12px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px;border:1px solid #ddd;text-align:left}
      .btn{padding:6px 10px;background:#1976d2;color:#fff;text-decoration:none;border-radius:4px}
      .btn-delete{background:#d32f2f;border:none;color:#fff;padding:6px 8px;border-radius:4px;cursor:pointer}
      .muted{color:#666;font-size:0.9em}
      .controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
      .search{flex:1;padding:6px;border:1px solid #ccc;border-radius:4px}
      .pagination{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
    </style>
</head>
<body>
    <div class="container">
        <h1>My Files</h1>
        <div class="controls">
            <a class="btn" href="/upload" role="button">Upload</a>
            <a class="btn" href="/" role="button">Home</a>
            <button id="refreshBtn" class="btn" aria-label="Refresh files">Refresh</button>
            <input id="searchInput" class="search" placeholder="Search filenames..." aria-label="Search files">
        </div>
        <p id="loadingText" aria-live="polite">Initializing...</p>
        <div id="error" role="alert" style="display:none;color:red;"></div>

        <table id="filesTable" role="table" aria-describedby="loadingText">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Privacy</th>
                    <th>Size</th>
                    <th>Uploaded At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="emptyState" style="display:none;">You have not uploaded any files yet.</p>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        const API_URL = window.API_URL || '';

        function getToken(){ return localStorage.getItem('token') || ''; }
        function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[m]; }); }
        function showError(msg){ const e = document.getElementById('error'); e.innerText = msg; e.style.display='block'; }

        function humanSize(bytes){
            if(!bytes) return '0 B';
            const units = ['B','KB','MB','GB'];
            let i=0; let size=Number(bytes);
            while(size>=1024 && i<units.length-1){ size/=1024; i++; }
            return `${size.toFixed(1)} ${units[i]}`;
        }

        // client-side paging + search
        let allFiles = [];
        let currentPage = 1;
        const PAGE_SIZE = 8;

        function renderPage(){
            const tbody = document.querySelector("#filesTable tbody");
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const filtered = allFiles.filter(f => f.filename.toLowerCase().includes(query));
            const start = (currentPage-1)*PAGE_SIZE;
            const pageItems = filtered.slice(start, start+PAGE_SIZE);
            tbody.innerHTML = '';
            document.getElementById('emptyState').style.display = filtered.length ? 'none' : 'block';
            pageItems.forEach(f => {
                const tr = document.createElement("tr");
                tr.dataset.id = f._id;
                tr.innerHTML = `
                    <td><strong>${escapeHtml(f.filename)}</strong><div class="muted">${escapeHtml(f.path || '')}</div></td>
                    <td>${escapeHtml(f.privacy)}</td>
                    <td>${humanSize(f.size)}</td>
                    <td>${new Date(f.uploaded_at).toLocaleString()}</td>
                    <td>
                        <a class="btn" href="${API_URL}/files/${f._id}/download" aria-label="Download ${escapeHtml(f.filename)}">Download</a>
                        <button class="btn-delete" onclick="deleteFile('${f._id}')" aria-label="Delete ${escapeHtml(f.filename)}">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            renderPagination(filtered.length);
        }

        function renderPagination(total){
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
            for(let i=1;i<=pages;i++){
                const btn = document.createElement('button');
                btn.className='btn';
                btn.innerText = i;
                if(i===currentPage) btn.style.opacity = 0.6;
                btn.onclick = ()=> { currentPage = i; renderPage(); };
                container.appendChild(btn);
            }
        }

        async function loadFiles() {
            const token = getToken();
            if(!token) { alert("Login required"); window.location.href="/login"; return; }
            const loading = document.getElementById('loadingText'); loading.innerText = 'Loading...';
            try {
                const res = await fetch(`${API_URL}/my-files`, { headers: { "Authorization": token } });
                if(!res.ok) { if(res.status===401) { window.location.href='/login'; return; } throw new Error('Network response not ok'); }
                allFiles = await res.json();
                currentPage = 1;
                renderPage();
            } catch(err){ showError('Could not load files. ' + err.message); }
            finally{ loading.innerText = ''; }
        }

        async function deleteFile(id) {
            if(!confirm('Are you sure you want to delete this file?')) return;
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if(row) row.style.opacity = 0.5;
            const token = getToken();
            try {
                const res = await fetch(`${API_URL}/files/${id}`, { method: "DELETE", headers: { "Authorization": token } });
                if(!res.ok) throw new Error('Delete failed');
                // remove from client cache and re-render
                allFiles = allFiles.filter(f=>f._id !== id);
                renderPage();
            } catch(e){
                if(row) row.style.opacity = 1;
                alert('Failed to delete: ' + e.message);
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', ()=> loadFiles());
        document.getElementById('searchInput').addEventListener('input', ()=> { currentPage = 1; renderPage(); });
        document.addEventListener('keydown', function(e){ if(e.key==='Enter' && document.activeElement.classList.contains('btn-delete')) document.activeElement.click(); });

        // initial load
        loadFiles();
    </script>
</body>
</html>
