<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>My Files</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .container{max-width:900px;margin:20px auto;padding:12px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px;border:1px solid #ddd;text-align:left}
      .btn{padding:6px 10px;background:#1976d2;color:#fff;text-decoration:none;border-radius:4px}
      .btn-delete{background:#d32f2f;border:none;color:#fff;padding:6px 8px;border-radius:4px;cursor:pointer}
    </style>
</head>
<body>
    <div class="container">
        <h1>My Files</h1>
        <div id="controls">
            <a class="btn" href="/upload" role="button">Upload</a>
            <a class="btn" href="/" role="button">Home</a>
            <button id="refreshBtn" class="btn" aria-label="Refresh files">Refresh</button>
        </div>
        <p id="loadingText" aria-live="polite">Initializing...</p>
        <div id="error" role="alert" style="display:none;color:red;"></div>

        <table id="filesTable" role="table" aria-describedby="loadingText">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Privacy</th>
                    <th>Size (Bytes)</th>
                    <th>Uploaded At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="emptyState" style="display:none;">You have not uploaded any files yet.</p>
    </div>

    <script>
        const API_URL = window.API_URL || '';

        function getToken(){ return localStorage.getItem('token') || ''; }
        function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[m]; }); }
        function showError(msg){ const e = document.getElementById('error'); e.innerText = msg; e.style.display='block'; }

        async function loadFiles() {
            const token = getToken();
            if(!token) { alert("Login required"); window.location.href="/login"; return; }
            const loading = document.getElementById('loadingText'); loading.innerText = 'Loading...';
            try {
                const res = await fetch(`${API_URL}/my-files`, { headers: { "Authorization": token } });
                if(!res.ok) { if(res.status===401) { window.location.href='/login'; return; } throw new Error('Network response not ok'); }
                const files = await res.json();
                const tbody = document.querySelector("#filesTable tbody");
                tbody.innerHTML = "";
                document.getElementById('emptyState').style.display = files.length ? 'none' : 'block';
                files.forEach(f => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td><strong>${escapeHtml(f.filename)}</strong></td>
                        <td>${escapeHtml(f.privacy)}</td>
                        <td>${Number(f.size) || 0}</td>
                        <td>${new Date(f.uploaded_at).toLocaleString()}</td>
                        <td>
                            <a class="btn" href="${API_URL}/files/${f._id}/download" aria-label="Download ${escapeHtml(f.filename)}">Download</a>
                            <button class="btn-delete" onclick="deleteFile('${f._id}')" aria-label="Delete ${escapeHtml(f.filename)}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(err){ showError('Could not load files. ' + err.message); }
            finally{ loading.innerText = ''; }
        }

        async function deleteFile(id) {
            if(!confirm('Are you sure you want to delete this file?')) return;
            const token = getToken();
            const res = await fetch(`${API_URL}/files/${id}`, { method: "DELETE", headers: { "Authorization": token } });
            if(!res.ok){ const err = await res.json().catch(()=>({error:'Unknown'})); alert(err.error || 'Failed to delete'); }
            else{ alert('Deleted'); loadFiles(); }
        }

        document.getElementById('refreshBtn').addEventListener('click', ()=> loadFiles());
        document.addEventListener('keydown', function(e){ if(e.key==='Enter' && document.activeElement.classList.contains('btn-delete')) document.activeElement.click(); });

        // initial load
        loadFiles();
    </script>
</body>
</html>
