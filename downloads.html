<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Public Downloads</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Public Downloads</h1>

        <p id="loadingText" aria-live="polite">Initializing...</p>
        <div id="error" role="alert" style="display:none;color:red"></div>

        <table id="downloadsTable" role="table" aria-describedby="loadingText">
            <thead>
                <tr>
                    <th scope="col">Filename</th>
                    <th scope="col">Uploader</th>
                    <th scope="col">Uploaded At</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="emptyState" style="display:none;">No public files available at the moment.</p>
        <a class="btn" href="/">Home</a>
    </div>

    <script>
        const API_URL = window.API_URL || '';

        function showError(msg){
            const err = document.getElementById('error');
            err.innerText = msg;
            err.style.display = 'block';
        }

        async function loadDownloads() {
            const loadingEl = document.getElementById("loadingText");
            loadingEl.innerText = "Loading files...";
            try {
                const res = await fetch(`${API_URL}/public-files`);
                if(!res.ok) throw new Error('Network response was not ok');
                const files = await res.json();

                const tbody = document.querySelector("#downloadsTable tbody");
                tbody.innerHTML = "";
                document.getElementById("emptyState").style.display = files.length ? 'none' : 'block';

                files.forEach(f => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${escapeHtml(f.filename)}</td>
                        <td>${escapeHtml(f.uploaded_by || 'â€”')}</td>
                        <td>${new Date(f.uploaded_at).toLocaleString()}</td>
                        <td>
                            <a class="btn download-btn" role="button" tabindex="0" href="${API_URL}/files/${f._id}/download" aria-label="Download ${escapeHtml(f.filename)}">Download</a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                showError('Failed to load files. ' + err.message);
            } finally {
                loadingEl.innerText = "";
            }
        }

        // Basic HTML escaping to avoid XSS from filename/uploader fields
        function escapeHtml(s) {
            if(!s) return '';
            return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]; });
        }

        // keyboard support for download links (Enter key)
        document.addEventListener('keydown', function(e){
            if(e.key === 'Enter' && document.activeElement.classList.contains('download-btn')){
                document.activeElement.click();
            }
        });

        loadDownloads();
    </script>
</body>
</html>
